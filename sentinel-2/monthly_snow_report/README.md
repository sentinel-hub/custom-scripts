# Monthly Snow Report Script

<a href="#" id='togglescript'>Show</a> script or [download](script.js){:target="_blank"} it.
<div id='script_view' style="display:none">
{% highlight javascript %}
      {% include_relative script.js %}
{% endhighlight %}
</div>

## Evaluate and visualize
 - [Sentinel Playground temporal](https://apps.sentinel-hub.com/sentinel-playground-temporal/?source=S2&lat=42.77826738996885&lng=0.44219970703125&zoom=10&preset=CUSTOM&layers=B01,B02,B03&maxcc=95&gain=1.0&gamma=1.0&time=2015-01-01%7C2019-03-30&atmFilter=ATMCOR&showDates=false&evalscript=Ly9WRVJTSU9OPTMgKGF1dG8tY29udmVydGVkIGZyb20gMSkKLyoKU291cmNlOiBAbmthcmFzaWFrIC8gd3d3LmthcmFzaWFrLm5ldAoKTW9udGhseSBzbm93IHJlcG9ydC4KVGlyZWQgb2Ygd2FpdGluZyB0aGUgcGVyZmVjdCBpbWFnZSB3aXRoIG5vIGNsb3VkIHRvIHNob3cgdGhlIHNub3cgY292ZXIgPyBUaGlzIG1vbnRobHkgc25vdyByZXBvcnQgaXMgaGVyZSBmb3IgeW91LgpUaGlzIHNjcmlwdCB3aWxsIGZpbmQgd2hlcmUgdGhlIHNub3cgaXMgcGVyc2lzdGVudCB3aXRoaW4gdGhlIGxhc3QgMzEgZGF5cyAoZnJvbSBjaG9zZW4gZGF0ZSkuCkluIG9yZGVyIHRvIHdlbGwgcmVwcmVzZW50IHRoZSBsYW5kLWNvdmVyLCB0aGUgc2NyaXB0IHdpbGwgc3RvcmUgZWFjaCBwZXJ0aW5lbnQgZGF0ZSBpbiBhIGxpc3QgYW5kIHdpbGwgcmVwcmVzZW50cyB0aGUgbWVkaWFuIHZhbHVlLgoKVGhpcyBzZW50aW5lbC0yIHNjcmlwdCB2b2x1bnRhcmlseSBjb2xvciBpbiBncmVlbiB0aGUgaW1hZ2UgdG8gYmV0dGVyIGRpZmZlcmVudGlhdGUgdGhlIHNub3cgZnJvbSB0aGUgb3RoZXIgbGFuZC1jb3Zlci4KClNjcmlwdCByZXF1aXJlcyBtdWx0aS10ZW1wb3JhbCBwcm9jZXNzaW5nLgoqLwoKLy8gUHV0IDMgdG8gaGF2ZSBzeW50aGVzaXMgb2YgdGhlIGxhc3QgMyBtb250aHMKdmFyIG51bWJlck9mTW9udGhzVG9Vc2UgPSAxOwovLyBUaHJlc29sZCB0byBjb25zaWRlciBwaXhlbCBhcyBzbm93CnZhciBORFNJdGhyZXNvbGQgPSAwLjIwOwovLyBJbiBvcmRlciB0byBkaXNtaXNzIHNub3cgZnJvbSB3YXRlcgp2YXIgcmVkVGhyZXNvbGQgPSAwLjI7Ci8vIEluIG9yZGVyIHRvIGRpc21pc3MgY2xvdWRzCnZhciBibHVlVGhyZXNvbGQgPSAwLjE4OwoKZnVuY3Rpb24gc2V0dXAoKSB7CiAgcmV0dXJuIHsKICAgIGlucHV0OiBbewogICAgICBiYW5kczogWwogICAgICAgICAgIkIwMiIsCiAgICAgICAgICAiQjAzIiwKICAgICAgICAgICJCMDQiLAogICAgICAgICAgIkIxMSIKICAgICAgXQogICAgfV0sCiAgICBvdXRwdXQ6IHsgYmFuZHM6IDMgfSwKICAgIG1vc2FpY2tpbmc6ICJPUkJJVCIKICB9Cn0KCgpmdW5jdGlvbiBORFNJKHNhbXBsZSkgewogICAgcmV0dXJuICgoc2FtcGxlLkIwMyAtIHNhbXBsZS5CMTEpIC8gKDAuMDEgKyBzYW1wbGUuQjAzICsgc2FtcGxlLkIxMSkpOwp9CgpmdW5jdGlvbiBtZWRpYW4odmFsdWVzKSB7CiAgICAvLyBmcm9tIGh0dHBzOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzQ1MzA5NDQ3L2NhbGN1bGF0aW5nLW1lZGlhbi1qYXZhc2NyaXB0CiAgICBpZiAodmFsdWVzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIDA7CgogICAgdmFsdWVzLnNvcnQoZnVuY3Rpb24oYSwgYikgewogICAgICAgIHJldHVybiBhIC0gYjsKICAgIH0pOwoKICAgIHZhciBoYWxmID0gTWF0aC5mbG9vcih2YWx1ZXMubGVuZ3RoIC8gMik7CgogICAgaWYgKHZhbHVlcy5sZW5ndGggJSAyKQogICAgICAgIHJldHVybiB2YWx1ZXNbaGFsZl07CgogICAgcmV0dXJuICh2YWx1ZXNbaGFsZiAtIDFdICsgdmFsdWVzW2hhbGZdKSAvIDIuMDsKfQoKZnVuY3Rpb24gZXZhbHVhdGVQaXhlbChzYW1wbGVzLCBzY2VuZXMpIHsKICAgIC8vIGZvciBzbm93IHNjZW5lCiAgICBsZXQgc25vd3lDb3VudCA9IDA7CiAgICBsZXQgc25vd0IwMiA9IFtdOwogICAgbGV0IHNub3dCMDMgPSBbXTsKICAgIGxldCBzbm93QjA0ID0gW107CgogICAgLy8gZm9yIHVuc25vdyBzY2VuZQogICAgbGV0IEIwMiA9IFtdOwogICAgbGV0IEIwMyA9IFtdOwogICAgbGV0IEIwNCA9IFtdOwoKICAgIC8vIHRvIG1hbmFnZSBpbWFnZSBsZW5ndGggYmV0d2VlbiB0aWxlcwogICAgcmVhbFNhbXBsZUxlbmd0aCA9IDA7CgogICAgZm9yIChpID0gMDsgaSA8IHNhbXBsZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAvLyBpbiBvcmRlciB0byBhdm9pZCBibGFjayBwaXhlbCAodGhlIG9uZXMgYmV0d2VlbiB0aWxlcykKCiAgICAgICAgaWYgKChzYW1wbGVzW2ldLkIwMiA%2BIDApIHx8IChzYW1wbGVzW2ldLkIwMyA%2BIDApKSB7CiAgICAgICAgICAgIHJlYWxTYW1wbGVMZW5ndGgrKzsKCiAgICAgICAgICAgIC8vIGZvdW5kIHNub3cKICAgICAgICAgICAgaWYgKChORFNJKHNhbXBsZXNbaV0pID4gTkRTSXRocmVzb2xkKSAmIChzYW1wbGVzW2ldLkIwNCA%2BIHJlZFRocmVzb2xkKSkgewogICAgICAgICAgICAgICAgc25vd3lDb3VudCsrOwogICAgICAgICAgICAgICAgc25vd0IwMi5wdXNoKHNhbXBsZXNbaV0uQjAyKTtzbm93QjAzLnB1c2goc2FtcGxlc1tpXS5CMDMpO3Nub3dCMDQucHVzaChzYW1wbGVzW2ldLkIwNCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gbWF5YmUgaXQgaXMgc25vd3kgYnV0IGNsb3Vkcy4uLgogICAgICAgICAgICAvLyBzbyBjb3VudCBhcyBzbm93IGJ1dCBub3QgbWVtb3JpemluZyBwaXhlbCB2YWx1ZXMuCiAgICAgICAgICAgIGVsc2UgaWYgKChzYW1wbGVzW2ldLkIwMiA%2BIGJsdWVUaHJlc29sZCkgJiAoc2FtcGxlc1tpXS5CMDQgPiByZWRUaHJlc29sZCkpIHsKICAgICAgICAgICAgICAgIHNub3d5Q291bnQrKzsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBub3Qgc25vdwogICAgICAgICAgICBlbHNlIGlmIChzYW1wbGVzW2ldLkIwMiA8IGJsdWVUaHJlc29sZCkgewogICAgICAgICAgICAgICAgQjAyLnB1c2goc2FtcGxlc1tpXS5CMDIpO0IwMy5wdXNoKHNhbXBsZXNbaV0uQjAzKTtCMDQucHVzaChzYW1wbGVzW2ldLkIwNCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgaWYgKChzbm93QjAyID09IDApICYgKEIwMi5sZW5ndGggPT0gMCkpIHsKICAgICAgICAvLyBubyB2YWxpZCBkYXRhIGF2YWlsYWJsZSA6IGRhcmsgZ3JlZW4gY29sb3IKICAgICAgICBjb2xvck1hcCA9IFsuMDUsLjIsLjA1XTsKICAgIH0gZWxzZSBpZiAoKHNub3d5Q291bnQgPT0gcmVhbFNhbXBsZUxlbmd0aCkgfHwgKEIwMi5sZW5ndGg8MSkpIHsKICAgICAgICAvLyBzbm93Q29sb3JNYXAKICAgICAgICBjb2xvck1hcCA9IFsxLjEgKiBtZWRpYW4oc25vd0IwNCksIDEuMyAqIG1lZGlhbihzbm93QjAzKSwgMS4xICogbWVkaWFuKHNub3dCMDIpXTsKICAgIH0gZWxzZSBpZiAoQjAyLmxlbmd0aCA%2BPSAxKSB7CiAgICAgICAgLy8gZGVmYXVsdENvbG9yTWFwCiAgICAgICAgY29sb3JNYXAgPSBbMS41ICogbWVkaWFuKEIwNCksIDIuNSAqIG1lZGlhbihCMDMpLCAxLjUgKiBtZWRpYW4oQjAyKV07CiAgICB9CgogICAgcmV0dXJuIGNvbG9yTWFwOwp9CgpmdW5jdGlvbiBmaWx0ZXJTY2VuZXMoc2NlbmVzLCBpbnB1dE1ldGFkYXRhKSB7CiAgICByZXR1cm4gc2NlbmVzLmZpbHRlcihmdW5jdGlvbihzY2VuZSkgewogICAgICAgIHJldHVybiBzY2VuZS5kYXRlLmdldFRpbWUoKSA%2BPSAoaW5wdXRNZXRhZGF0YS50by5nZXRUaW1lKCkgLSAobnVtYmVyT2ZNb250aHNUb1VzZSAqIDMxICogMjQgKiAzNjAwICogMTAwMCkpOwogICAgfSk7Cn0K&temporal=true){:target="_blank"}    


## General description of the script

Tired of waiting the perfect image with no cloud to show the snow cover?
This monthly snow report script is for you.

This code will find where the snow is persistent for the last 30 days (from the chosen date).
In order to well represent the land-cover, the script will store each pertinent date in a list and will represent the median value.

As the aim of the script is to represent the snow cover, all the other land-cover are saturated in green in order to easily see the snow.

The limitations are essentially:
* a few white rooftops
* when no uncloudy pixel is available in the previous 30 days

Thus, it is possible to make the script working with 90 days in order to have a trimonthly synthesis by changing settings to: "numberOfMonthsToUse = 3".

## Author of the script

Nicolas Karasiak

## Description of representative images

Persistent snow cover in February 2019 in Corsica

![Persistent snow cover in February 2019 in Corsica](fig/02_corsica_2019-02-28.jpg)

Persistent snow cover in Pyre패ne패es in March 2019

![Pyre패ne패es persistent snow cover in March 2019](fig/04_pyrenees_2019-03-30.jpg)

Mer de Glace / Alpes persistent snow cover in the previous 30 days of 24 april 2019.

![Chamonix persistent snow cover in the previous 30 days of 24 April 2019.](fig/05_chamonix_2019-04-24.jpg)

See the [supplementary material](supplementary_material.pdf) for more examples.

## Credits

- [Harel Dan temporal script](https://github.com/hareldunn/GIS_Repo/blob/master/Multi-Temporal%20NDVI%20for%20Sentinel%20Hub%20Custom%20Scripts){:target="_blank"}  
- NDSI/red thresold was adapted from [here](http://www.cesbio.ups-tlse.fr/multitemp/?p=6446){:target="_blank"}  
- [Snow representation by Simon Gascoin](https://apps.sentinel-hub.com/eo-browser/?lat=53.07650&lng=-6.21291&zoom=14&time=2019-02-02&preset=CUSTOM&datasource=Sentinel-2%20L1C&layers=B01,B02,B03&evalscript=Ly8gQ3VzdG9tIHNjcmlwdCBieSBTaW1vbiBHYXNjb2luCnZhciBjcDE9WzIuNSpCMDQsMS4yKkIwOCwxLjUqQjAyXTsKdmFyIGNwMj1bMS4xKkIwNCwxLjMqQjAzLDEuMSpCMDJdOwp2YXIgbmRzaT0oQjAzLUIxMSkvKDAuMDErQjAzK0IxMSk7CnJldHVybiAoKG5kc2k%2BMC4yKSYoQjAzPjAuMTUpKSA%2FIGNwMiA6IGNwMTs%3D){:target="_blank"}  
